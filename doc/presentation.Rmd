---
title: "Tooltips with ggplot2"
author: "Matthew Plourde"
date: "Sunday, April 19, 2015"
runtime: shiny
output: ioslides_presentation
---


```{r, include=FALSE, cache=FALSE, echo=FALSE}
library(svgg)
library(ggplot2)
```

## Code no more complex than this

### ui.r
```{r, eval=FALSE, echo=TRUE}
shinyUI(fluidPage(
  plotOutput('myplot')  
))
```

### server.r
```{r, eval=FALSE, echo=TRUE}
library(ggplot2)
function(input, output) {
  output$myplot <- renderPlot({  
    ggplot(iris, aes(Sepal.Length, Sepal.Width)) + geom_point()
  })
}
```


## To make mouse-sensitive output this

```{r, echo=FALSE}
renderSVGG({
  p <- ggplot(iris, aes(Sepal.Length, Sepal.Width)) + geom_point()
  p
})
```

## And label mapping via aesthetics

```{r, eval=FALSE, echo=TRUE}
ggplot(iris, aes(Sepal.Length, Sepal.Width, point.labels=Species)) + 
  geom_point()
```

```{r, echo=FALSE}
renderSVGG({
  p <- ggplot(iris, aes(Sepal.Length, Sepal.Width, point.labels=Species)) + geom_point()
  p
})
```

## Existing approaches to getting mouse events

### Dont use ggplot2
Packages such as **RCharts** and **googleVis** support them
issues: it's not ggplot

### gridSVG::grid.garnish
Traverse ggplot GROB and garnish desired geoms with labels
issues: ggplot2 grob naming is opaque. Its very challenging to navigate the GROB structure (even more challenging with facets, groupings)


## An easier way

- Bootstrap is already prepared to give you tooltips and popovers
- Define your own geoms that bind your labels at the time of definition and carry over to SVG in a bootstrap-compliant way

## Shiny output binding for SVG

```
var svgOutputBinding = new Shiny.OutputBinding(); 
$.extend(svgOutputBinding, {
    find: function(scope) {
        return $(scope).find('.shiny-svg-output');
    },
    renderValue: function(el, data) {
        var $el = $(el)
        $el.html(data.svg_html);

        var el_id = $el.attr('id');

        ....

        var $tooltip_els = $('#' + el_id + ' svg [data-original-title]')
        $tooltip_els.tooltip(data.tooltip_opts)
    }
});
Shiny.outputBindings.register(svgOutputBinding, 'shiny.svgOutput');

```

## Shiny SVG output function
```{r, eval=FALSE}
svgOutput <- function(....) {
  ....
  attachDependencies(
    container(
        id=paste(outputId, '_proxy_', sep='_'), 
        class='shiny-plot-output', 
        style=style, 
        div(id=outputId, class='shiny-svg-output')
        tags$canvas(id=paste(outputId, '_canvas_', sep='_'), style='display:none')
    ),
    svg.js
  )
}
``` 

## ggplot2::GeomPoint modifications
```{r, eval=FALSE}
draw <- function(., data, scales, coordinates, na.rm = FALSE, ...) {
  ....
  with(coord_transform(coordinates, data, scales), {
    ggname(.... gp=gpar(...., `data-original-title`=point.labels)))
  })
}
```

## ggplot2::GeomPoint modifications
```{r, eval=FALSE}
default_aes <- function(.) {
  aes(....
    point.labels=paste0( '(', 
        paste(
            if (is.numeric(x)) sprintf('%.2f', x) else x, 
            if (is.numeric(y)) sprintf('%.2f', y) else y,
            sep=', '),  ')')
  )
}
```

```{r, eval=FALSE}
geom_point <- ggplot2::geom_point
environment(geom_point) <- environment()
```

## ggplot2 to SVG conversion
```{r, eval=FALSE}
ggplot2SVG <- function(g, ..., id, width=400, height=400, res=72) {
    plot.temp <- tempfile()
    svg.temp <- tempfile()
    on.exit({unlink(plot.temp);unlink(svg.temp)})

    png(file=plot.temp, height=height, width=width)
    print(g)
    svg.txt <- as(
      grid.export(..., name=svg.temp, res=res)$svg, 
      'character'
    )
    dev.off()

    return(svg.txt)
}
```

## Shiny SVG render function
```{r, eval=FALSE}
renderSVGG <- function(....) {
  ....
  markRenderFunction(outputFunc, 
    function(shinysession, name, ...) {
        ....
        if (width == 'auto') width <- 
            shinysession$clientData[[paste0(prefix, name, '__proxy__width')]]
        if (height == 'auto') height <- 
            shinysession$clientData[[paste0(prefix, name, '__proxy__height')]]
        ....
        svg.html <- ggplot2SVG(func(), res=res*pixelratio, 
            width=width*pixelratio, height=height*pixelratio)
        svg.html <- paste0('<div class="svg_container">', svg.html, '</div>')

        list(....,
          svg_html=svg.html
        )
    }
  )
}
```



## Slide with R Code and Output

```{r}
summary(cars)
```

## Slide with Plot

```{r, echo=FALSE}
plot(cars)
```

